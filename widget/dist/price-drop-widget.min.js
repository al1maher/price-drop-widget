"use strict";var PriceDropWidget=(()=>{var f=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var y=(i,r)=>{for(var e in r)f(i,e,{get:r[e],enumerable:!0})},w=(i,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of b(r))!x.call(i,o)&&o!==e&&f(i,o,{get:()=>r[o],enumerable:!(t=g(r,o))||t.enumerable});return i};var v=i=>w(f({},"__esModule",{value:!0}),i);var C={};y(C,{PriceDropWidget:()=>p,init:()=>k});var u=`
:host {
  font-family: inherit; 
  --pd-accent: #ffd814;
  --pd-bg: #fff;
  --pd-border: #e0e0e0;
  --pd-radius: 4px;
  display: block;
  width: 100%;
  margin: 0; 
  height: auto;
  min-height: 100%;
  box-sizing: border-box;
}

.pd-container {
  background: var(--pd-bg);
  border: 1px solid var(--pd-border);
  padding: 16px;
  border-radius: var(--pd-radius);
  box-shadow: none; 
  display: flex;
  flex-direction: column;
  gap: 12px;
  height: 100%;
  box-sizing: border-box; 
  justify-content: center;
}

.pd-title {
  font-size: 14px;
  font-weight: 700;
  color: #333;
  margin: 0;
  line-height: 1.4;
}

.pd-form {
  display: flex;
  gap: 8px;
  width: 100%;
}

.pd-input {
  flex: 1;
  padding: 8px 10px;
  border: 1px solid var(--pd-border);
  border-radius: var(--pd-radius);
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
  font-family: inherit;
}

.pd-input:focus {
  border-color: var(--pd-accent);
}

.pd-btn {
  background: var(--pd-accent);
  color: var(--pd-btn-text, #fff);
  border: none;
  padding: 0 16px;
  border-radius: var(--pd-radius);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s;
  white-space: nowrap;
  height: 36px; /* Align with input */
  align-self: center;
  font-family: inherit;
}

.pd-btn:hover {
  opacity: 0.9;
}

.pd-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.pd-message {
  font-size: 13px;
  margin-top: 4px;
  display: none;
}

.pd-message.success {
  display: block;
  color: #28a745;
}

.pd-message.error {
  display: block;
  color: #d0021b;
}

/* Spinner */
.pd-spinner {
  display: inline-block;
  width: 10px;
  height: 10px;
  border: 2px solid rgba(255,255,255,0.4);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 0.8s linear infinite;
  margin-right: 6px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Shake animation for errors */
@keyframes pd-shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
  20%, 40%, 60%, 80% { transform: translateX(4px); }
}

.pd-shake {
  animation: pd-shake 0.5s ease-in-out;
}

/* Hidden form after success */
.pd-hidden {
  display: none;
}

@media (max-width: 480px) {
  .pd-form {
    flex-direction: column;
  }
  .pd-btn {
    width: 100%;
  }
}
`;var p=class extends HTMLElement{constructor(){super();this.config={};this._submitting=!1;this._rendered=!1;this.shadow=this.attachShadow({mode:"open"})}connectedCallback(){this.render()}init(e){this.config={...this.config,...e},this.render()}render(){this.config.product?this.config.product.price==="Unknown"&&!this._rendered&&(console.log("Price was Unknown, re-extracting..."),this.config.product=this.extractPageData()):this.config.product=this.extractPageData();let e=this.config.apiEndpoint||"http://localhost:3000",t="";this.config.accentColor&&(t+=`:host { --pd-accent: ${this.config.accentColor}; }`),this.config.textColor&&(t+=`:host { --pd-btn-text: ${this.config.textColor}; }`),this.shadow.innerHTML=`
    <style>${u} ${t}</style>
    <div class="pd-container">
      <h3 class="pd-title">\u{1F514} Email me if this product gets cheaper</h3>
      <form class="pd-form">
        <input type="email" class="pd-input" placeholder="Enter your email" required value="${this.config.email||""}">
        <button type="submit" class="pd-btn">Track Price</button>
      </form>
      <div class="pd-message"></div>
    </div>
  `,this.form=this.shadow.querySelector("form"),this.input=this.shadow.querySelector("input"),this.btn=this.shadow.querySelector("button"),this.msg=this.shadow.querySelector(".pd-message"),this.form.addEventListener("submit",o=>this.handleSubmit(o,e)),this._rendered=!0,console.log("Current config.product after render:",this.config.product)}extractPageData(){let e=window.location.href,t="Unknown",o="";if(e.includes("amazon.")){let d=['.a-price[data-a-color="price"] .a-offscreen','.a-price[data-a-color="base"] .a-offscreen',"#corePrice_feature_div .a-offscreen",".apexPriceToPay .a-offscreen","#priceblock_ourprice","#priceblock_dealprice",".a-price-whole"];for(let c of d){let a=document.querySelector(c);if(a?.textContent?.trim()){let n=a.textContent.trim();if(n=n.replace(/\s+/g,""),/[\$£€¥]?\d+[.,]\d{2}/.test(n)||/\d+/.test(n)){t=n,console.log(`Found price with selector: ${c}`,t);break}}}if(t==="Unknown"||/^\d+\.$/.test(t)){let c=document.querySelector(".a-price-whole"),a=document.querySelector(".a-price-fraction"),n=document.querySelector(".a-price-symbol");if(c&&a){let l=n?.textContent?.trim()||"$",h=c.textContent?.replace(".","")||"",m=a.textContent||"00";t=`${l}${h}.${m}`,console.log("Constructed price from parts:",t)}}o=document.querySelector("#productTitle")?.textContent?.trim()||document.title}else if(e.includes("ebay.")){let d=[".x-price-primary .ux-textspans",".x-bin-price__content .ux-textspans",".x-price-primary",".x-bin-price__content",'[itemprop="price"]',".display-price"];for(let c of d){let a=document.querySelector(c);if(a?.textContent?.trim()){t=a.textContent.trim();break}}o=document.querySelector(".x-item-title__mainTitle")?.textContent?.trim()||document.title}let s={name:o||document.title,price:t,url:window.location.href};return console.log("Price Drop Widget - Extracted:",s),s}async handleSubmit(e,t){if(e.preventDefault(),this._submitting)return;let o=this.input.value;if(o){if(!this.config.product){console.error("No product data available!"),this.setMessage("error","Could not extract product information.");return}this.setLoading(!0);try{let s=this.config.product,d={email:o,product:{title:s.name,name:s.name,price:s.price,url:s.url}};console.log("Sending payload:",d),console.log("Product data from config:",s);let c=new AbortController,a=setTimeout(()=>c.abort(),1e4);try{let n=await fetch(`${t}/subscribe-price-drop`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d),signal:c.signal});clearTimeout(a);let l=await n.json();console.log("Server response:",l),n.ok?(this.setMessage("success","You are now subscribed!"),this.form.classList.add("pd-hidden"),localStorage.setItem(`pd_sub_${s.url}`,"true")):l.error==="already_subscribed"?this.setMessage("error","You are already tracking this item."):this.setMessage("error","Error: "+(l.error||"Unknown error"))}catch(n){if(clearTimeout(a),n instanceof Error&&n.name==="AbortError")this.setMessage("error","Request timed out. Please try again.");else throw n}}catch(s){console.error("Submit error:",s),this.setMessage("error","Network error. Please try again.")}finally{this.setLoading(!1)}}}setLoading(e){this._submitting=e,e?(this.btn.disabled=!0,this.btn.innerHTML='<span class="pd-spinner"></span> Saving...',this.msg.className="pd-message",this.input.disabled=!0):(this.btn.disabled=!1,this.btn.textContent="Track Price",this.input.disabled=!1)}setMessage(e,t){this.msg.textContent=t,this.msg.className=`pd-message ${e}`,e==="error"&&this.form&&(this.form.classList.remove("pd-shake"),this.form.offsetWidth,this.form.classList.add("pd-shake"))}};customElements.get("price-drop-widget")||customElements.define("price-drop-widget",p);function k(i){let r=document.querySelector("price-drop-widget");if(!r&&i.containerId){let e=document.getElementById(i.containerId);e&&(r=document.createElement("price-drop-widget"),e.innerHTML="",e.appendChild(r))}if(r){if(i.containerId){let e=document.getElementById(i.containerId);e&&(e.style.minHeight="150px",e.style.display="block",e.style.transition="height 0.3s ease")}r.init(i)}}return v(C);})();
//# sourceMappingURL=price-drop-widget.min.js.map
